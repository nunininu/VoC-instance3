import pandas as pd
import networkx as nx

print("ğŸ”¹[1] CSV íŒŒì¼ ë¡œë“œ")
df = pd.read_csv("keyword_edge_cleaned.csv")
print(f"ğŸ”¹[1] ë¡œë“œ ì™„ë£Œ: {len(df)}í–‰")

print("ğŸ”¹[2] ê·¸ë˜í”„ ìƒì„± ì‹œì‘ (ê°€ì¤‘ì¹˜ ì»¬ëŸ¼: similarity)")
G = nx.DiGraph()
for _, row in df.iterrows():
    G.add_edge(row["source"], row["target"], weight=row["similarity"])
print(f"ğŸ”¹[2] ìƒì„±ëœ ì—£ì§€ ìˆ˜: {len(G.edges())}")

print("ğŸ”¹[3] ì‚¬ì´í´ ì œê±° (SCC ê¸°ë°˜)")
removed_edges = set()
sccs = list(nx.strongly_connected_components(G))
for scc in sccs:
    if len(scc) > 1:
        subgraph = G.subgraph(scc).copy()
        # ì—£ì§€ ê°€ì¤‘ì¹˜ ê¸°ì¤€ ì •ë ¬ (ë‚´ë¦¼ì°¨ìˆœ)
        edges_sorted = sorted(subgraph.edges(data=True), key=lambda x: x[2]["weight"], reverse=True)
        # ê°€ì¥ ê°€ì¤‘ì¹˜ í° ì—£ì§€ í•˜ë‚˜ ì œê±°
        for u, v, _ in edges_sorted:
            if G.has_edge(u, v):
                G.remove_edge(u, v)
                removed_edges.add((u, v))
                break

print(f"ğŸ”¹[3] ì œê±°ëœ ì—£ì§€ ìˆ˜: {len(removed_edges)}")

# ì¶”ê°€ë¡œ DAG í™•ì¸
is_dag = nx.is_directed_acyclic_graph(G)
print(f"ğŸ”¹[4] DAG ë§Œì¡± ì—¬ë¶€: {is_dag}")

print("ğŸ”¹[5] ê²°ê³¼ ì €ì¥")
acyclic_edges = pd.DataFrame(
    [(u, v, G[u][v]["weight"]) for u, v in G.edges()],
    columns=["source", "target", "similarity"]
)
acyclic_edges.to_csv("keyword_edge_acyclic.csv", index=False)
print("âœ… ì™„ë£Œ: keyword_edge_acyclic.csv ì €ì¥ë¨")
